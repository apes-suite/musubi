<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="A multi-level parallel lattice Boltzmann solver within the APES suite.">
    <meta name="author" content="University of Siegen" >
    <link rel="icon" href="../../../favicon.png">

    <title>Toolchain &ndash; Musubi</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="../../../css/fontawesome.min.css" rel="stylesheet">
    <link href="../../../css/brands.min.css" rel="stylesheet">
    <link href="../../../css/regular.min.css" rel="stylesheet">
    <link href="../../../css/solid.min.css" rel="stylesheet">
    <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
    <link href="../../../css/v4-shims.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { equationNumbers: { autoNumber: "AMS" } }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async
            integrity="sha256-DViIOMYdwlM/axqoGDPeUyf0urLoHMN4QACBKyB58Uw=" crossorigin="anonymous"></script>
    <!-- Other scripts and stylesheets -->
    <link href="../../../css/local.css" rel="stylesheet">
    <link href="../../../css/pygments.css" rel="stylesheet">
    <script src="../../../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../../../index.html">Musubi </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../../index.html">Documentation</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/types.html">Derived Types</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/programs.html">Programs</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../../../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>Toolchain</h1>
    <div class="container p-2 mb-4 bg-light border rounded-3">
      <div class="row align-items-center justify-content-between">
        <div class="col">
          <ul class="list-inline" style="margin-bottom:0px; display:inline">
          </ul>
        </div>
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../../index.html'>Documentation</a></li>
                <li class="breadcrumb-item"><a href='../index.html'>Examples</a></li>
                <li class="breadcrumb-item"><a href='index.html'>Tutorials</a></li>
              <li class="breadcrumb-item active" aria-current="page">Toolchain</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-3">
        <div class="card card-body bg-light" id="sidebar-toc">
          <ul class="nav flex-column align-items">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Documentation</a>
            </li>
          </ul>
          <hr>
          <nav class="nav nav-pills flex-column">
              <a class="nav-link" href="../../bibliography.html">Bibliography</a>
              <a class="nav-link" href="../index.html">Examples</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/index.html">Weakly compressible flows</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/application/index.html">Applications</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/application/Nonreflecting_BC/index.html">Nonreflecting Boundary Conditions</a>
              <a class="nav-link" href="../fluid/application/Nozzle/index.html">Nozzle</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/application/Nozzle/NOZ_FlowInAndAround/index.html">Nozzle flow inside an around</a>
              <a class="nav-link" href="../fluid/application/Nozzle/NOZ_FlowInside/index.html">Nozzle flow inside</a>

                </nav>

                </nav>
              <a class="nav-link" href="../fluid/benchmark/index.html">Benchmarks</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/Channel2D/index.html">Channel 2D</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/index.html">Channel 2D Boundary Conditions</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_MfrBB_PressExpol/index.html">Channel 2D MfrBB PressExpol</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_MfrEq_PressEq/index.html">Channel 2D MfrEq PressEq</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_PressExpol_PressExpol/index.html">Channel 2D PressExpol PressExpol</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_VelBB_PressExpol/index.html">Channel 2D VelBB PressExpol</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_VelBFL_PressExpol/index.html">Channel 2D VelBFL PressExpol</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_VelEq_PressEq/index.html">Channel 2D VelEq PressEq</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_BoundaryConditions/C2D_BC_VelNonEqExpol_PressNonEqExpol/index.html">Channel 2D VelNonEqExpol PressNonEqExpol</a>

                </nav>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/index.html">Poisueille flow in a channel 2D</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/C2D_Simple_BGK/index.html">Poisueille flow in a channel 2D</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/C2D_Simple_drtBGK/index.html">Poisueille flow in a channel 2D</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/C2D_Simple_hrrBGK/index.html">Poisueille flow in a channel 2D</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/C2D_Simple_prrBGK/index.html">Poisueille flow in a channel 2D</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/C2D_Simple_rBGK/index.html">Poisueille flow in a channel 2D</a>
              <a class="nav-link" href="../fluid/benchmark/Channel2D/C2D_Simple/C2D_Simple_rrBGK/index.html">Poisueille flow in a channel 2D</a>

                </nav>

                </nav>
              <a class="nav-link" href="../fluid/benchmark/Channel3D/index.html">Channel 3D test cases</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/Channel3D/C3D_Cylinder_MultiLevel_LES/index.html">Turbulent flow around the cylinder in a channel 3D at Re=3900</a>
              <a class="nav-link" href="../fluid/benchmark/Channel3D/C3D_Sphere_MultiLevel_LES/index.html">Turbulent flow around the sphere in a channel 3D</a>

                </nav>
              <a class="nav-link" href="../fluid/benchmark/TurbulentChannel/index.html">Turbulent channel</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/TurbulentChannel/TC_SingleLevel/index.html">Turbulent channel wall model validation</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/TurbulentChannel/TC_SingleLevel/TC_SL_MuskerFixedPoint/index.html">Turbulent channel wall model Musker</a>
              <a class="nav-link" href="../fluid/benchmark/TurbulentChannel/TC_SingleLevel/TC_SL_MuskerNewton/index.html">Turbulent channel wall model Musker (Newton)</a>
              <a class="nav-link" href="../fluid/benchmark/TurbulentChannel/TC_SingleLevel/TC_SL_PowerLaw/index.html">Turbulent channel wall model Power-Law</a>
              <a class="nav-link" href="../fluid/benchmark/TurbulentChannel/TC_SingleLevel/TC_SL_ReichardtFixedPoint/index.html">Turbulent channel wall model Reichardt</a>

                </nav>

                </nav>
              <a class="nav-link" href="../fluid/benchmark/Vortex_convection/index.html">Convected vortex in a domain with a coarser grid at the center</a>
              <a class="nav-link" href="../fluid/benchmark/absorbingLayer/index.html">Absorbing layers</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/absorbingLayer/acousticCylinder2D/index.html">Acoustic Line Source</a>
              <a class="nav-link" href="../fluid/benchmark/absorbingLayer/acousticLineSource2D/index.html">Acoustic Line Source 2D</a>
              <a class="nav-link" href="../fluid/benchmark/absorbingLayer/acousticPulse2D/index.html">Acoustic pulse 2D</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid/benchmark/absorbingLayer/acousticPulse2D/absLayerBox/index.html">Acoustic pulse 2D with absorbing layer box 2d</a>
              <a class="nav-link" href="../fluid/benchmark/absorbingLayer/acousticPulse2D/absLayerPlane/index.html">Acoustic pulse 2D with absorbing layer plane</a>
              <a class="nav-link" href="../fluid/benchmark/absorbingLayer/acousticPulse2D/absLayerRadial/index.html">Acoustic pulse 2D with absorbing layer radial</a>

                </nav>

                </nav>
              <a class="nav-link" href="../fluid/benchmark/gaussianPulse/index.html">Gaussian Pulse in Pressure in a Cube</a>
              <a class="nav-link" href="../fluid/benchmark/trackOutside/index.html">Tracking point outside the domain</a>

                </nav>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/index.html">Incompressible flows</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/application/index.html">Applications</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/index.html">Benchmarks</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/Channel2D/index.html">Channel 2D</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/Channel2D/C2D_Cylinder_MultiLevel/index.html">Flow around the cylinder 2D single level</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Channel2D/C2D_Cylinder_SingleLevel/index.html">Flow around the cylinder 2D single level</a>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Channel3D/index.html">Channel 3D</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/Channel3D/C3D_Simple/index.html">Simple Flow in a 3D Channel</a>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/benchmark/ConcentricCylinders/index.html">Concentric Cylinders</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/ConcentricCylinders/COC_CoeutteFlow/index.html">Concentric Cylinders</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/ConcentricCylinders/COC_CoeutteFlow_MultiLevel/index.html">Concentric Cylinders</a>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/benchmark/LidDrivenCavity/index.html">Lid driven cavity</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/LidDrivenCavity/LDC_MultiLevel/index.html">Lid driven cavity</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/LidDrivenCavity/LDC_Simple/index.html">Lid driven cavity</a>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Pipe/index.html">Pipe 3D</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/Pipe/PIP_Force/index.html">Pipe Force</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Pipe/PIP_LES/index.html">Pipe LES</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Pipe/PIP_MultiLevel/index.html">Pipe 3D</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Pipe/PIP_Simple/index.html">Pipe Simple</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/Pipe/PIP_Split/index.html">Pipe Split</a>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/benchmark/TaylorGreenVortex/index.html">Taylor Green Vortex</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/TaylorGreenVortex/TGV_LES/index.html">Taylor-Green Vortex with LES Turbulence Models at Re = 1600</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../fluid_incompressible/benchmark/TaylorGreenVortex/TGV_LES/TGV_SmagGradU/index.html">Taylor-Green Vortex with WALE Smagorinsky (GradU) model at Re = 1600</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/TaylorGreenVortex/TGV_LES/TGV_SmagPDF/index.html">Taylor-Green Vortex with WALE Smagorinsky (PDF) model at Re = 1600</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/TaylorGreenVortex/TGV_LES/TGV_Vreman/index.html">Taylor-Green Vortex with Vreman LES model at Re = 1600</a>
              <a class="nav-link" href="../fluid_incompressible/benchmark/TaylorGreenVortex/TGV_LES/TGV_WALE/index.html">Taylor-Green Vortex with WALE LES model at Re = 1600</a>

                </nav>

                </nav>
              <a class="nav-link" href="../fluid_incompressible/benchmark/gaussianPulse/index.html">Gaussian Pulse in Pressure in a Cube</a>

                </nav>

                </nav>
              <a class="nav-link" href="../particles/index.html">Particulate Flows</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../particles/DPS/index.html">Unresolved Discrete Particle Simulation (DPS)</a>
              <a class="nav-link" href="../particles/MEM/index.html">Fully Resolved Model</a>

                </nav>
              <a class="nav-link" href="index.html">Tutorials</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="tut_00_prerequisites.html">Prerequisites</a>
              <a class="nav-link" href="tut_01_mus_config.html">Configuration</a>
              <a class="nav-link active disabled" href="tut_02_mus_toolchain.html">Toolchain</a>
              <a class="nav-link" href="tut_03_tracking.html">Tracking</a>
              <a class="nav-link" href="tut_04_boundaries.html">Boundary Conditions</a>
              <a class="nav-link" href="tut_05_restart.html">Restart</a>
              <a class="nav-link" href="tut_06_initial.html">Initial Conditions</a>
              <a class="nav-link" href="tut_07_convergence.html">Abort Criteria</a>
              <a class="nav-link" href="tut_08_source.html">Source Terms</a>
              <a class="nav-link" href="tut_09_mus_multilevel.html">Multilevel Simulations</a>
              <a class="nav-link" href="tut_10_Musubi2.html">Prerequisites</a>

                </nav>

                </nav>
              <a class="nav-link" href="../../features/index.html">Feature Overview</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../features/comp_proc.html">Description of the Multi-Level Algorithm</a>
              <a class="nav-link" href="../../features/data_struc.html">Data Structures</a>
              <a class="nav-link" href="../../features/intp_methods.html">Interpolation Methods</a>
              <a class="nav-link" href="../../features/multispecies.html">Multispecies</a>
              <a class="nav-link" href="../../features/mus_hvs_scheme_impl.html">Musubi-Harvesting</a>
              <a class="nav-link" href="../../features/mus_nonNewtonianTheory.html">Non-Newtonian Fluid Simulations</a>
              <a class="nav-link" href="../../features/mus_vectorization.html">Vectorization</a>
              <a class="nav-link" href="../../features/scheme.html">Scheme Implementation</a>

                </nav>
              <a class="nav-link" href="../../usage/index.html">Build and run Musubi</a>
          </nav>
        </div>
      </div>

    <div class="col-9" id='text'>
      <div class="alert alert-warning">
<p class="alert-title h4">Warning</p>
<p>WORK IN PROGRESS</p>
</div>
<p>Navigate: <a href="tut_01_mus_config.html">&larr; Configuration</a>
| <a href="index.html">Overview</a>
| <a href="tut_03_tracking.html">Tracking &rarr;</a></p>
<h1 id="toolchain">Toolchain</h1>
<p>In this tutorial, you will learn how to use the complete toolchain of the APES
suite to deploy simulations. This includes the generation of the mesh with
<em>Seeder</em>, running the actual simulation with <em>Musubi</em> and finally
post-processing the results with <code>mus_harvesting</code> which generates files to be
visualized with standard tools like Gnuplot and Paraview. Therefore we use a
channel as an example. The test case can be found under
<code>examples/tutorials/tutorial_cases/tutorial_channelGeneric</code>.
This test case will be used in most of the following tutorials.
Some parts will be explained in more depths later.</p>
<h2 id="preparing-the-simulation-folder">Preparing the Simulation Folder</h2>
<p>Generate the folders</p>
<ul>
<li>mesh</li>
<li>tracking</li>
<li>restart</li>
<li>harvest</li>
<li>output</li>
</ul>
<p>using:</p>
<div class="codehilite"><pre><span></span><code>mdkir<span class="w"> </span>mesh<span class="w"> </span>tracking<span class="w"> </span>restart<span class="w"> </span>harvest<span class="w"> </span>output
</code></pre></div>

<h2 id="generate-the-mesh">Generate the Mesh</h2>
<p>Make sure that <em>Seeder</em> is compiled and you know how to call it
( <a href="|Seederurl|/index.html">see here</a>).</p>
<p>At first, we define the <code>seeder.lua</code> file containing general informations
/ global variables like sizes and the refinement levels of the mesh.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Global variables]</span>
<span class="c1">-- Height of the channel [m]</span>
<span class="n">height</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1">-- Length to height ratio</span>
<span class="n">l_h</span> <span class="o">=</span> <span class="mf">8.0</span>
<span class="c1">-- Length of the channel [m]</span>
<span class="n">length</span> <span class="o">=</span> <span class="n">l_h</span><span class="o">*</span><span class="n">height</span>
<span class="c1">-- Depth of the channel [m]</span>
<span class="n">depth</span> <span class="o">=</span> <span class="n">length</span>
<span class="c1">-- General level of mesh refinement</span>
<span class="n">level</span> <span class="o">=</span>  <span class="mi">8</span>
<span class="c1">-- Special levels for local refinement. Set to 0 to make refinement optional.</span>
<span class="c1">-- If it should be used, activate useRefine in the &#39;Geometry definition&#39;. The</span>
<span class="c1">-- refinmentLevels will be increased then.</span>
<span class="n">refinementLevel</span>  <span class="o">=</span> <span class="mi">0</span>
<span class="n">refinementLevel2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">--outputpreview = true</span>
<span class="c1">--! [Global variables]</span>
</code></pre></div>

<p>In the next part we have some variables with boolian values. We use them to
activate or deactivate some parts of the script which give us some flexiblity to
easily modify the case. With this script we can have a look at the effect of
qvalues, periodic boundaries and the use of different STL files.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Geometry definition]</span>
<span class="n">case2d</span> <span class="o">=</span> <span class="kc">false</span>           <span class="c1">-- Creates a 2D channel if set to true</span>
<span class="n">usePeriodic</span> <span class="o">=</span> <span class="kc">true</span>       <span class="c1">-- Activates periodic boundaries</span>
<span class="n">qValues</span> <span class="o">=</span> <span class="kc">true</span>           <span class="c1">-- Activates qvalues</span>
<span class="n">useObstacle</span> <span class="o">=</span> <span class="kc">false</span>      <span class="c1">-- Activates obstacle in the channel</span>
<span class="n">fixHeight</span> <span class="o">=</span> <span class="kc">true</span>         <span class="c1">-- Channel&#39;s height is fixed and is used to compute dx</span>
<span class="n">useRefine</span> <span class="o">=</span> <span class="kc">false</span>        <span class="c1">-- Activate refinement, increase levels by 1 and 2.</span>
<span class="n">smoothlevels</span> <span class="o">=</span> <span class="kc">false</span>     <span class="c1">-- False avoids refinement of single elements.</span>
<span class="n">smoothbounds</span> <span class="o">=</span> <span class="kc">false</span>     <span class="c1">-- False avoids refinement of single elements.</span>
<span class="c1">--! [Geometry definition]</span>
</code></pre></div>

<p>You might remember the <code>fixHeight</code> value from above. If it is set to <code>true</code> the
<code>dx</code> is computed by the specified height of the channel. Else <code>dx</code> is computed
defining the length of the channel first.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [dx computed by height]</span>
<span class="kr">if</span> <span class="n">fixHeight</span> <span class="kr">then</span>
  <span class="c1">-- Number of elements in the height</span>
  <span class="n">nHeight</span> <span class="o">=</span> <span class="mi">2</span><span class="o">^</span><span class="p">(</span><span class="n">level</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
  <span class="c1">-- Element size [m]</span>
  <span class="n">dx</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="n">nHeight</span>
  <span class="c1">-- Number of elements in bounding cube</span>
  <span class="c1">-- = number of elements in channel + inlet + outlet</span>
  <span class="n">nLength</span> <span class="o">=</span> <span class="n">nHeight</span><span class="o">*</span><span class="n">l_h</span> <span class="o">+</span> <span class="mi">2</span>
  <span class="c1">-- Level required to reach computed dx</span>
  <span class="n">level</span> <span class="o">=</span> <span class="nb">math.ceil</span><span class="p">(</span> <span class="nb">math.log</span><span class="p">(</span><span class="n">nLength</span><span class="p">)</span><span class="o">/</span><span class="nb">math.log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  <span class="c1">-- Length of the bounding cube</span>
  <span class="n">length_bnd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">level</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<span class="c1">--! [dx computed by height]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">--! [dx computed by length]</span>
<span class="kr">else</span>
  <span class="c1">-- Length of the bounding cube</span>
  <span class="n">length_bnd</span> <span class="o">=</span> <span class="n">length</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="mi">2</span><span class="o">^</span><span class="n">level</span><span class="p">)</span>
  <span class="c1">-- Element size [m]</span>
  <span class="n">dx</span>  <span class="o">=</span> <span class="n">length_bnd</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">^</span><span class="n">level</span><span class="p">)</span>
  <span class="c1">-- Number of elements in height</span>
  <span class="n">nHeight</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">math.floor</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">l_h</span><span class="p">))</span>
  <span class="c1">-- Height of the channel</span>
  <span class="n">height</span> <span class="o">=</span> <span class="n">nHeight</span><span class="o">*</span><span class="n">dx</span>
<span class="kr">end</span>
<span class="c1">--! [dx computed by length]</span>
</code></pre></div>

<p>Here, we have some reference values that have effect on the geometry of the
channel. You might change them and compare the effects later on in Paraview.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Reference values]</span>
<span class="c1">-- A minimum level, by which all parts in the computational domain should at</span>
<span class="c1">-- least be resolved with. Default is 0. Here, set it to value calcualted above.</span>
<span class="n">minlevel</span><span class="o">=</span><span class="n">level</span>
<span class="c1">-- A maximum level, which is reached on finest level of refinement.</span>
<span class="n">maxLevel</span> <span class="o">=</span> <span class="n">level</span><span class="o">+</span><span class="nb">math.max</span><span class="p">(</span><span class="n">refinementLevel</span><span class="p">,</span> <span class="n">refinementLevel2</span><span class="p">)</span>
<span class="c1">-- Smallest element size (on finest level) [m]</span>
<span class="n">dxMin</span>  <span class="o">=</span> <span class="n">length_bnd</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">maxLevel</span><span class="p">)</span>
<span class="c1">-- Half of element size on finest level [m]</span>
<span class="n">dx_half</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dxMin</span>
<span class="c1">-- Smallest possible element size</span>
<span class="n">dx_eps</span> <span class="o">=</span> <span class="n">length_bnd</span><span class="o">/</span><span class="mi">2</span><span class="o">^</span><span class="mi">20</span>
</code></pre></div>

<p>The next section is about refinement at selected positions.
The usage of refinements is explained in <a href="tut_09_mus_multilevel.html">[chapter 09]</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Increase refinement levels, if useRefine is active.</span>
<span class="kr">if</span> <span class="n">useRefine</span> <span class="kr">then</span>
  <span class="n">refinementLevel</span>  <span class="o">=</span> <span class="n">refinementLevel</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="c1">-- Refinement level 2 can only be one larger than 1, otherwise level jump is</span>
  <span class="c1">-- too big.</span>
  <span class="n">refinementLevel2</span> <span class="o">=</span> <span class="n">refinementLevel</span> <span class="o">+</span> <span class="mi">1</span>
<span class="kr">end</span>

<span class="c1">--! [Refinement box 1]</span>
<span class="c1">-- Size of refinement box 1 in x-direction</span>
<span class="n">size_x</span> <span class="o">=</span> <span class="mf">0.75</span><span class="o">*</span><span class="n">length</span>
<span class="c1">-- Start of refinement box 1 (x)  based on length</span>
<span class="n">start_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.425</span><span class="o">*</span><span class="n">length</span>
<span class="c1">-- Size of refinement box 1 in y-direction</span>
<span class="n">size_y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">height</span>
<span class="c1">-- Start of refinement box 1 (y)  based on height</span>
<span class="n">start_y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">height</span>
<span class="c1">-- Size of refinement box 1 in y-direction</span>
<span class="n">size_z</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">height</span>
<span class="c1">-- Start of refinement box 1 (z)  based on height</span>
<span class="n">start_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">height</span>
<span class="c1">--! [Refinement box 1]</span>


<span class="c1">--! [Refinement box 2]</span>
<span class="c1">-- Size of refinement box 2 in x-direction and start of it</span>
<span class="n">start2_x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.375</span><span class="o">*</span><span class="n">length</span>
<span class="n">size2_x</span>  <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">size_x</span>
<span class="c1">-- Size of refinement box 2 in y-direction and start of it</span>
<span class="n">size2_y</span>  <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">size_y</span>
<span class="n">start2_y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span> <span class="n">size2_y</span>
<span class="c1">-- Size of refinement box 2 in z-direction and start of it</span>
<span class="n">size2_z</span>  <span class="o">=</span> <span class="n">size2_y</span> <span class="o">-</span> <span class="n">dx_half</span>
<span class="n">start2_z</span> <span class="o">=</span> <span class="n">start2_y</span> <span class="o">+</span> <span class="n">dx_half</span><span class="o">/</span><span class="mf">2.0</span>
<span class="c1">--! [Refinement box 2]</span>


<span class="c1">--! [Reference values]</span>
</code></pre></div>

<p>Next, we define the bounding cube. It is the box that includes the complete
simulation domain. It must be large enough, otherwise it just truncates all
geometries that go beyond this cube.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Bounding cube]</span>
<span class="c1">-- Bounding_cube: two entries (origin and length in this order, if no keys used)</span>
<span class="n">bounding_cube</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length_bnd</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length_bnd</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length_bnd</span> <span class="p">},</span>
  <span class="n">length</span> <span class="o">=</span> <span class="n">length_bnd</span>
<span class="p">}</span>
<span class="c1">--! [Bounding cube]</span>
</code></pre></div>

<p>This part is followed by the <code>spatial_object</code> table. Here we define the seed
and some refinements. If <code>useRefine = false</code> the <code>level</code> of our refinement boxes
will be the same as the rest of our mesh and so no refinement will be added.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Spatial objects]</span>
<span class="n">spatial_object</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;seed&#39;</span>
    <span class="p">},</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
      <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dx_half</span> <span class="p">},</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="c1">--! [Refinement box 1 &amp; 2]</span>
  <span class="p">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;refinement&#39;</span><span class="p">,</span>
      <span class="n">level</span> <span class="o">=</span> <span class="n">refinementLevel</span><span class="o">+</span><span class="n">level</span><span class="p">,</span>
      <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;box1&#39;</span>
    <span class="p">},</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
      <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="n">start_x</span><span class="p">,</span> <span class="n">start_y</span><span class="p">,</span> <span class="n">start_z</span> <span class="p">},</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
          <span class="p">{</span> <span class="n">size_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">size_z</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;refinement&#39;</span><span class="p">,</span>
      <span class="n">level</span> <span class="o">=</span> <span class="n">refinementLevel2</span><span class="o">+</span><span class="n">level</span><span class="p">,</span>
      <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;box2&#39;</span>
    <span class="p">},</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
      <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="n">start2_x</span><span class="p">,</span> <span class="n">start2_y</span><span class="p">,</span> <span class="n">start2_z</span> <span class="p">},</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
          <span class="p">{</span> <span class="n">size2_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">size2_y</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">size2_z</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="c1">--! [Refinement box 1 &amp; 2]</span>
</code></pre></div>

<p>Here we can define our boundaries the <code>inlet</code> and the <code>outlet</code> of the channel.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Inlet and outlet boundary conditions]</span>
  <span class="p">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
      <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;east&#39;</span> <span class="c1">-- outlet</span>
    <span class="p">},</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
      <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="o">+</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span><span class="o">-</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">depth</span><span class="o">-</span><span class="n">dx_eps</span> <span class="p">},</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
      <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;west&#39;</span> <span class="c1">-- inlet</span>
    <span class="p">},</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
      <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="o">-</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span><span class="o">-</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">depth</span><span class="o">-</span><span class="n">dx_eps</span> <span class="p">},</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
          <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span> <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="c1">--! [Inlet and outlet boundary conditions]</span>
</code></pre></div>

<p>Here we can define our boundaries <code>north</code> and <code>south</code> of the channel.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Walls]</span>
    <span class="p">{</span>
      <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;north&#39;</span>
      <span class="p">},</span>
      <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="o">-</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">height</span><span class="o">+</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">depth</span><span class="o">-</span><span class="n">dx_eps</span> <span class="p">},</span>
          <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
            <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span> <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;south&#39;</span>
      <span class="p">},</span>
      <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="o">-</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span><span class="o">-</span><span class="n">dx_eps</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">depth</span><span class="o">-</span><span class="n">dx_eps</span> <span class="p">},</span>
          <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
            <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span> <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
<span class="c1">--! [Walls]</span>
<span class="p">}</span>
<span class="c1">--! [Spatial objects]</span>
</code></pre></div>

<p>It is possible for the channel to make use of periodic boundaries.
Therefore you need to define two planes close to each other that are repeated
along the channel depth (<code>usePeriodic=true</code>) .</p>
<div class="alert alert-info">
<p class="alert-title h4">Note</p>
<p>Since we can't use if conditions inside a table we use
<code>table.insert(spatial_object, ...)</code> to append this part to the <code>spatial_object</code>
table.</p>
</div>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Use periodic boundaries]</span>
<span class="c1">-- If usePeriodic is active, periodic boundary conditions are used in depth,</span>
<span class="c1">-- which means in z-direction in this case. This is one way of creating a quasi-</span>
<span class="c1">-- 2D domain.</span>
<span class="kr">if</span> <span class="n">usePeriodic</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
  <span class="n">depth</span> <span class="o">=</span> <span class="n">dx</span>
  <span class="nb">table.insert</span><span class="p">(</span><span class="n">spatial_object</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;periodic&#39;</span>
      <span class="p">},</span>
      <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">plane1</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">-- top plane</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span>
              <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span> <span class="o">-</span> <span class="n">dx_eps</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span> <span class="o">-</span> <span class="n">dx_eps</span><span class="p">,</span>
               <span class="n">depth</span> <span class="o">+</span> <span class="n">dx_half</span><span class="o">/</span><span class="mf">4.0</span>
            <span class="p">},</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
              <span class="p">{</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
              <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="n">plane2</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">-- bottom plane</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span>
              <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span> <span class="o">+</span> <span class="n">dx_eps</span><span class="p">,</span>
              <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span> <span class="o">+</span> <span class="n">dx_eps</span><span class="p">,</span>
              <span class="o">-</span> <span class="n">dx_half</span><span class="o">/</span><span class="mf">4.0</span>
            <span class="p">},</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
              <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
              <span class="p">{</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="c1">--! [Use periodic boundaries]</span>
</code></pre></div>

<p>Of course you do not have to use periodic boundaries. Instead you could use a
script that defines specific boundaries for <code>top</code> and <code>bottom</code> of the channel.
Here, we can make use of the aformentionded boolean to easily switch between two
cases:  while we choose a depth of <code>dx</code> for a 2D case, for a 3D test case we use
a rectangular channel, where the depth is equal to the height.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Non-periodic]</span>
<span class="c1">-- If usePeriodic is deactived, but case2d is selected, we use another wayt to</span>
<span class="c1">-- create a quasi-2D channel: a channel with 1 element in depth. If not, we</span>
<span class="c1">-- create a 3D channel.</span>
<span class="kr">else</span>
  <span class="kr">if</span> <span class="n">case2d</span> <span class="kr">then</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">dx</span>
  <span class="kr">else</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">height</span>
  <span class="kr">end</span>
  <span class="nb">table.insert</span><span class="p">(</span><span class="n">spatial_object</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
      <span class="p">},</span>
      <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span> <span class="o">-</span> <span class="n">dx_eps</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span> <span class="o">-</span> <span class="n">dx_eps</span><span class="p">,</span>
             <span class="mf">0.5</span><span class="o">*</span><span class="n">depth</span> <span class="o">+</span> <span class="n">dx_eps</span>
          <span class="p">},</span>
          <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
            <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="c1">-- object</span>
      <span class="p">}</span> <span class="c1">-- geometry</span>
    <span class="p">}</span> <span class="c1">-- spatial object</span>
  <span class="p">)</span>
  <span class="nb">table.insert</span><span class="p">(</span><span class="n">spatial_object</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
      <span class="p">},</span>
      <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span> <span class="o">-</span> <span class="n">dx_eps</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">height</span> <span class="o">-</span> <span class="n">dx_eps</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">depth</span> <span class="o">-</span> <span class="n">dx_eps</span>
          <span class="p">},</span>
          <span class="n">vec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">},</span>
            <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dx_eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">},</span><span class="c1">-- object</span>
      <span class="p">}</span> <span class="c1">-- geometry</span>
    <span class="p">}</span> <span class="c1">-- spatial object</span>
  <span class="p">)</span>
<span class="kr">end</span> <span class="c1">--periodic</span>
<span class="c1">--! [Non-periodic]</span>
</code></pre></div>

<p>In order to simulate a flow around an obstacle you might activate
<code>useObstacle=true</code>. Here you can choose between two stl files for a sphere (2D)
or a cylinder (3D). You have to make sure that the files are located in the
defined directory. Now it makes sense to activate qvalues. This allows to
refine the mesh at i.e. circular boundaries. This is done with
<code>calc_dist = true</code> in the attribute table of a spatial object.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Use of obstacles]</span>
<span class="c1">-- If obstacle is true, we distinguish between 2D (cylinder) and 3D (sphere)</span>
<span class="c1">-- case.</span>
<span class="kr">if</span> <span class="n">useObstacle</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
  <span class="kr">if</span> <span class="n">case2d</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
    <span class="n">stlfile</span>  <span class="o">=</span> <span class="s1">&#39;stl/cylinder.stl&#39;</span>
    <span class="n">stlLabel</span> <span class="o">=</span> <span class="s1">&#39;cylinder&#39;</span>
  <span class="kr">else</span>
    <span class="kr">if</span> <span class="n">usePeriodic</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
      <span class="n">stlfile</span>  <span class="o">=</span> <span class="s1">&#39;stl/cylinder.stl&#39;</span>
      <span class="n">stlLabel</span> <span class="o">=</span> <span class="s1">&#39;cylinder&#39;</span>
    <span class="kr">else</span>
      <span class="n">stlfile</span>  <span class="o">=</span> <span class="s1">&#39;stl/sphere.stl&#39;</span>
      <span class="n">stlLabel</span> <span class="o">=</span> <span class="s1">&#39;sphere&#39;</span>
    <span class="kr">end</span>
  <span class="kr">end</span>
  <span class="c1">-- If we use an obstacle, we can make use of qValues. Here, we also</span>
  <span class="c1">-- distinguish between 2D (cylinder) and 3D (sphere). If we don&#39;t want to use</span>
  <span class="c1">-- them.</span>
  <span class="nb">table.insert</span><span class="p">(</span><span class="n">spatial_object</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">attribute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;boundary&#39;</span><span class="p">,</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">maxLevel</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">stlLabel</span><span class="p">,</span>
        <span class="n">calc_dist</span> <span class="o">=</span> <span class="n">qValues</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">geometry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;stl&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">filename</span> <span class="o">=</span> <span class="n">stlfile</span><span class="p">,</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="n">transformation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">-- Deformation factor to scale the obstacle. Here: 1 --&gt; remains the same.</span>
        <span class="n">deformation</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span>
        <span class="c1">-- In this case, we do not have to move the geometry.</span>
        <span class="n">translation</span> <span class="o">=</span>  <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="kr">end</span> <span class="c1">-- useObstacle</span>
<span class="c1">--! [Use of obstacles]</span>
</code></pre></div>

<p>Now you can start <em>Seeder</em>. If it successfully finishes, the mesh was generated.</p>
<h2 id="control-the-generated-mesh">Control the Generated Mesh</h2>
<p><em>Harvester</em> (integrated in <em>Seeder</em>) can process the mesh and generate a VTK
file, which can then be visualized by Paraview. Let's prepare the <code>sdr_harvester.lua</code>
for visualization. This is the simplest form of mesh visualization. For more
possibilities have a look at the
<a href="|seederurl|/index.html">Seeder documentation</a>.</p>
<p>The <code>sdr_harvester.lua</code> contains two parts. The first part defines the input:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Mesh to visualize, this is the common mesh definition, as found in</span>
<span class="c1">-- treelm/config.lua.</span>
<span class="c1">-- Either a predefined mesh, or the prefix for a mesh on disk.</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="s1">&#39;mesh/&#39;</span>

<span class="c1">-- If restart table and mesh are present then priority is given to restart</span>
<span class="n">restart</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">--   read = &#39;debug/final100_restart_ProtoData_header_100.lua&#39;</span>
<span class="p">}</span>
</code></pre></div>

<p>The second part defines the output</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- To dump complete mesh or restart file with out any tracking table</span>
<span class="c1">-- just default output table with basename, format as shown below</span>
<span class="c1">-- Configuration for the output to produce</span>
<span class="n">output_folder</span> <span class="o">=</span> <span class="s1">&#39;debug/&#39;</span>    <span class="c1">-- Prefix to use for the produced files,</span>
                            <span class="c1">-- if it ends in a &#39;/&#39;, this is a directory,</span>
                            <span class="c1">-- which needs to exist!</span>

<span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">format</span>   <span class="o">=</span> <span class="s1">&#39;vtk&#39;</span><span class="p">,</span>     <span class="c1">-- Visualization file format, defaults to &#39;vtk&#39;</span>
                        <span class="c1">-- Currently only vtk is supported here.</span>
  <span class="n">dataform</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>  <span class="c1">-- Form to write data in:</span>
                        <span class="c1">--   - &#39;binary&#39;,  or</span>
                        <span class="c1">--   - &#39;ascii&#39;</span>
                        <span class="c1">-- Default is &#39;binary&#39;</span>
  <span class="n">write_pvd</span> <span class="o">=</span> <span class="kc">false</span>     <span class="c1">-- write pvd file containing all timesteps</span>
                        <span class="c1">-- Default is true</span>
<span class="p">}</span>
</code></pre></div>

<p>Now run <code>~/apes/seeder/build/sdr_harvesting sdr_harvester.lua</code>.</p>
<p>Visualize the mesh with Paraview.
If you set up <code>usePeriodic = false</code> in seeder.lua
the VTU file should look like this:</p>
<p><img alt="periodic_false" src="images/use_periodic_false.png" title="3D channel"></p>
<p>Otherwise you can build a two-dimensional channel like this:</p>
<p><img alt="periodic_true" src="images/use_periodic_true.png" title="2D channel"></p>
<p>The periodic version looks like the 2D channel.</p>
<h2 id="run-musubi">Run Musubi</h2>
<p>Let's have a look at how to configure <em>Musubi</em>.</p>
<div class="alert alert-info">
<p class="alert-title h4">Note</p>
<p>Many things were mentioned in the <a href="tut_01_mus_config.html">last tutorial</a></p>
</div>
<p>In order to repeat the most important things, you can make use of a checklist.
For the simulation you need to define:</p>
<ol>
<li>Basic information</li>
<li><code>mesh</code> location of the directory is needed.</li>
<li><code>identify = { layout = "..", kind = "..", relaxation = ".."}</code>
     There exist default values, which are explained in the
     <a href="tut_1_mus_config.html">last tutorial</a>.</li>
<li>Physical and lattice reference values</li>
<li>Time settings that describe the time interval, the time maximum and an
     abort criteria.</li>
<li><code>fluid</code> table with information about physics and LBM units.</li>
<li><code>initial_condition</code> table with the initial pressure and velocity.</li>
<li><code>boundary_condition</code> table aims to tell <em>Musubi</em> how to handle the
     boundaries that were set up in seeder.lua. It reads the boundaries' labels
     and converts them into a wall, an inlet or an outlet.</li>
<li><code>tracking</code> table for information about the target output. It exist a
     description module for tracking that you find
     <a href="https://apes-suite.github.io/treelm//page/features/tracking.html">here</a>.</li>
</ol>
<h3 id="1-basic-information">1. Basic Information</h3>
<p>First we need to include <code>seeder.lua</code> to acess all geometric variables.</p>
<div class="codehilite"><pre><span></span><code><span class="nb">require</span> <span class="s2">&quot;seeder&quot;</span> <span class="c1">-- Tells musubi.lua to use defined variables from seeder.lua</span>
<span class="n">simulation_name</span> <span class="o">=</span> <span class="n">simName</span>
</code></pre></div>

<p>We define local variables that we need to turn off or on a few features:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Initialization of channel, for true --&gt; values&gt;0, false --&gt; initalized with 0</span>
<span class="n">initChannel</span> <span class="o">=</span> <span class="kc">false</span>
</code></pre></div>

<p>Next we define some variables:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Variables]</span>
<span class="c1">-- Collision Model (bgk, trt, mrt)</span>
<span class="n">relaxationModel</span> <span class="o">=</span> <span class="s1">&#39;bgk&#39;</span>
<span class="c1">-- Stencil (d1q3, d2q9, d3q6, d3q7, d3q19, d3q27)</span>
<span class="kr">if</span> <span class="n">case2d</span> <span class="kr">then</span>
  <span class="n">stencil</span> <span class="o">=</span> <span class="s1">&#39;d2q9&#39;</span> <span class="c1">-- use 2D stencil</span>
<span class="kr">else</span>
  <span class="n">stencil</span> <span class="o">=</span> <span class="s1">&#39;d3q19&#39;</span> <span class="c1">--use 3D stencil</span>
<span class="kr">end</span>
<span class="c1">-- Physics (fluid, fluid_incompressible)</span>
<span class="n">physicsModel</span> <span class="o">=</span> <span class="s1">&#39;fluid_incompressible&#39;</span>
<span class="c1">--! [Variables]</span>
</code></pre></div>

<p>And the flow parameters used:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Local variables]</span>
<span class="c1">-- Flow parameters</span>
<span class="c1">-- Density of the fluid [kg/m^3]</span>
<span class="n">rho0_phy</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1">-- Reynolds number of the flow</span>
<span class="n">Re</span> <span class="o">=</span> <span class="mi">60</span>
<span class="c1">-- speed of sound in air [m/s]</span>
<span class="n">cs_phy</span> <span class="o">=</span> <span class="mi">343</span>
</code></pre></div>

<p>Other flow parameters like Mach number and viscosity are defined below depending
on scaling type which is used to compute time step. In acoustic scaling, 
dt is computed for fixed Ma number whereas in diffusive scaling, dt is computed
for fixed viscosity and omega.
Here are timestep calculation for acoustic and diffusive scaling.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">------------------------ Compute physical timestep -----------------------------</span>
<span class="c1">-- Lattice speed of sound</span>
<span class="n">cs_lat</span> <span class="o">=</span> <span class="nb">math.sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<span class="kr">if</span> <span class="p">(</span><span class="n">scaling</span> <span class="o">==</span> <span class="s1">&#39;acoustic&#39;</span><span class="p">)</span> <span class="kr">then</span>
  <span class="c1">-- In acoustic scaling, Ma is fixed</span>
  <span class="c1">-- Mach number</span>
  <span class="n">Ma</span> <span class="o">=</span> <span class="mf">0.05</span>
  <span class="c1">-- Inflow velocity computed from Ma number [m/s]</span>
  <span class="n">vel_phy</span> <span class="o">=</span> <span class="n">Ma</span> <span class="o">*</span> <span class="n">cs_phy</span>
  <span class="c1">-- Kinematic viscosity of the fluid calculated from Re [m^2/s]</span>
  <span class="n">nu_phy</span> <span class="o">=</span> <span class="n">vel_phy</span> <span class="o">*</span> <span class="n">height</span> <span class="o">/</span> <span class="n">Re</span>
  <span class="c1">-- Lattice velocity</span>
  <span class="n">vel_lat</span> <span class="o">=</span> <span class="n">Ma</span> <span class="o">*</span> <span class="n">cs_lat</span>
  <span class="c1">-- Physical timestep computed from physical and lattice speed of sound</span>
  <span class="n">dt</span>  <span class="o">=</span> <span class="n">cs_lat</span> <span class="o">/</span> <span class="n">cs_phy</span> <span class="o">*</span> <span class="n">dx</span>
  <span class="c1">-- Lattice viscosity</span>
  <span class="n">nu_lat</span>  <span class="o">=</span> <span class="n">nu_phy</span><span class="o">*</span><span class="n">dt</span> <span class="o">/</span><span class="n">dx</span> <span class="o">/</span><span class="n">dx</span>
  <span class="c1">-- Relaxation parameter</span>
  <span class="n">omega</span>   <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">nu_lat</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="kr">else</span>
  <span class="c1">-- In diffusive scaling, Kinematic viscosity and omega are fixed</span>
  <span class="c1">-- Kinematic viscosity of the fluid [m^2/s]</span>
  <span class="n">nu_phy</span> <span class="o">=</span> <span class="mf">0.285</span>
  <span class="c1">-- Inflow velocity is computed from Re and viscosity [m/s]</span>
  <span class="n">vel_phy</span> <span class="o">=</span> <span class="n">Re</span> <span class="o">*</span> <span class="n">nu_phy</span> <span class="o">/</span> <span class="n">height</span>
  <span class="c1">-- Relaxation parameter</span>
  <span class="n">omega</span>   <span class="o">=</span> <span class="mf">1.7</span>
  <span class="c1">-- Lattice viscosity</span>
  <span class="n">nu_lat</span>  <span class="o">=</span> <span class="p">(</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">omega</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>
  <span class="c1">-- Physical timestep computed from physical and lattice velocity</span>
  <span class="n">dt</span>      <span class="o">=</span> <span class="n">nu_lat</span><span class="o">/</span><span class="n">nu_phy</span><span class="o">*</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span>
  <span class="c1">-- Lattice velocity</span>
  <span class="n">vel_lat</span>     <span class="o">=</span> <span class="n">vel_phy</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dx</span>
  <span class="c1">-- Mach number</span>
  <span class="n">Ma</span> <span class="o">=</span> <span class="n">vel_lat</span> <span class="o">*</span> <span class="n">cs_lat</span>
<span class="kr">end</span>
<span class="c1">--------------------------------------------------------------------------------</span>
</code></pre></div>

<p>Instead of the time step <code>dt</code>, we can alternatively prescribe the
phsical speed of sound (<code>cs</code>), which is especially for acoustic scaling,
where this is fixed independently of the mesh cell sizes.</p>
<p>The bulk viscosity for weakly-compressible model:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Bulk viscosity</span>
<span class="kr">if</span> <span class="n">physicsModel</span> <span class="o">==</span> <span class="s1">&#39;fluid&#39;</span> <span class="kr">then</span>
  <span class="n">bulk_visc</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">nu_phy</span>
<span class="kr">end</span>
</code></pre></div>

<p>Now we define our reference lattice values and derive some variables based on
previous defined ones:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Reference LB values]</span>
<span class="c1">-- Square of lattice speed of sound</span>
<span class="n">cs2_lat</span>  <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span>
<span class="c1">-- Lattice density</span>
<span class="n">rho0_lat</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1">--! [Reference LB values]</span>


<span class="c1">--! [Reference pressure in physical unit]</span>
<span class="n">press_ambient</span> <span class="o">=</span> <span class="n">rho0_phy</span><span class="o">*</span><span class="n">cs_phy</span><span class="o">^</span><span class="mi">2</span>
<span class="c1">--! [Reference pressure in physical unit]</span>
</code></pre></div>

<p>The last block defines some neccessery runtime variables:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">----------------------------- Time settings ------------------------------------</span>
<span class="c1">-- Physical simulation end time [s]</span>
<span class="n">tmax_phy</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="c1">-- Number of iterations required to reach physical simulation end time.</span>
<span class="c1">-- tmax_iter is also number of lattice iterations</span>
<span class="n">tmax_iter</span> <span class="o">=</span>  <span class="nb">math.ceil</span><span class="p">(</span><span class="n">tmax_phy</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
<span class="c1">-- Interval to check status of the simulation [s]</span>
<span class="n">interval_phy</span> <span class="o">=</span> <span class="n">tmax_phy</span><span class="o">/</span><span class="mf">10.0</span>
<span class="c1">-- Starting time for tracking output [s]</span>
<span class="n">trac_start</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="c1">-- Starting time for restart output [s]</span>
<span class="n">rest_start</span> <span class="o">=</span> <span class="n">tmax_phy</span><span class="o">/</span><span class="mf">4.0</span>
<span class="c1">------------------------- End of time settings ---------------------------------</span>
<span class="c1">--! [Local variables]</span>
</code></pre></div>

<h3 id="2-lua-functions">2. Lua Functions</h3>
<p>We need some lua functions to compute certain values. These are shown here:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">---------------------------- Lua functions -------------------------------------</span>
<span class="c1">--! [Pressure function]</span>
<span class="c1">-- Pressure drop across the channel length for Poiseuille flow</span>
<span class="n">press_drop</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">vel_phy</span> <span class="o">*</span> <span class="n">rho0_phy</span> <span class="o">*</span> <span class="n">nu_phy</span> <span class="o">*</span> <span class="n">length</span> <span class="o">/</span> <span class="n">height</span><span class="o">^</span><span class="mi">2</span>
<span class="kr">function</span> <span class="nf">pressureRef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">press_ambient</span> <span class="o">+</span> <span class="n">press_drop</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">x</span><span class="o">/</span><span class="n">length</span><span class="p">)</span>
<span class="kr">end</span>
<span class="c1">--! [Pressure function]</span>


<span class="c1">--! [Boundary pressure]</span>
<span class="c1">-- Pressure at inlet</span>
<span class="n">pressureIn</span><span class="o">=</span><span class="n">pressureRef</span><span class="p">(</span><span class="o">-</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c1">-- Pressure at outlet</span>
<span class="n">pressureOut</span><span class="o">=</span><span class="n">pressureRef</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c1">--! [Boundary pressure]</span>


<span class="c1">-- Reference values for the flow state in the 2d stationary channel at laminar</span>
<span class="c1">-- flow state</span>
<span class="c1">--! [Velocity function]</span>
<span class="kr">function</span> <span class="nf">velX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="n">velX_phy</span> <span class="o">=</span> <span class="n">vel_phy</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">height</span> <span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="p">)</span>
  <span class="kr">return</span> <span class="n">velX_phy</span>
<span class="kr">end</span>
<span class="c1">--! [Velocity function]</span>


<span class="kr">function</span> <span class="nf">Sxx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="kr">return</span> <span class="mf">0.0</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">Syy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="kr">return</span> <span class="mf">0.0</span>
<span class="kr">end</span>

<span class="c1">--! [Shear Stress Function]</span>
<span class="kr">function</span> <span class="nf">Sxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="n">tauxy</span><span class="o">=</span> <span class="o">-</span><span class="n">nu_phy</span><span class="o">*</span><span class="n">rho0_phy</span><span class="o">*</span><span class="mf">8.</span><span class="o">/</span><span class="n">height</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">vel_phy</span><span class="o">*</span><span class="n">y</span>
  <span class="n">S_xy</span> <span class="o">=</span> <span class="n">tauxy</span><span class="o">/</span><span class="n">nu_phy</span><span class="o">/</span><span class="n">rho0_phy</span>
  <span class="kr">return</span> <span class="n">S_xy</span>
<span class="kr">end</span>
<span class="c1">--! [Shear Stress Function]</span>

<span class="c1">-- Reference shear stress</span>
<span class="kr">function</span> <span class="nf">stressRef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">Sxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">rho0_phy</span><span class="o">*</span><span class="n">nu_phy</span>
<span class="kr">end</span>

<span class="c1">-- Consistent initial conditions for the channel</span>
<span class="kr">if</span> <span class="n">initChannel</span> <span class="kr">then</span>
  <span class="kr">function</span> <span class="nf">ic_velX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">velX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
  <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_pressure</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">if</span><span class="p">(</span> <span class="n">physicsModel</span><span class="o">==</span><span class="s1">&#39;fluid&#39;</span><span class="p">)</span> <span class="kr">then</span>
      <span class="kr">return</span> <span class="n">pressureRef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho0_phy</span><span class="o">*</span><span class="n">cs2</span><span class="o">*</span><span class="n">dx</span><span class="o">/</span><span class="n">dt</span>
    <span class="kr">else</span>
      <span class="kr">return</span> <span class="n">pressureRef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_Sxx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">Sxx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_Syy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">Syy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_Sxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">Sxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">else</span>
  <span class="c1">-- Initialize with 0</span>
  <span class="kr">function</span> <span class="nf">ic_velX</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="mf">0.</span>
  <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_pressure</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">press_ambient</span>
  <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_Sxx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="mf">0.</span>
  <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_Syy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="mf">0.</span>
  <span class="kr">end</span>
  <span class="kr">function</span> <span class="nf">ic_Sxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="kr">return</span> <span class="mf">0.</span>
  <span class="kr">end</span>
<span class="kr">end</span>
<span class="c1">---------------------------- Lua functions -------------------------------------</span>
</code></pre></div>

<h3 id="3-musubi-related-variables">3. Musubi Related Variables</h3>
<p>Here we define some variables used to control musubi's behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Simulation name used in tracking and restart outputs</span>
<span class="n">simulation_name</span> <span class="o">=</span> <span class="s1">&#39;channel&#39;</span>
<span class="c1">-- Print runtime information like memory usage at the end of the simulation</span>
<span class="n">printRuntimeInfo</span> <span class="o">=</span> <span class="kc">false</span>
<span class="c1">-- file to write measurement time of simulation for each solver step</span>
<span class="n">timing_file</span> <span class="o">=</span> <span class="s1">&#39;mus_timing.res&#39;</span>
<span class="c1">-- Location of mesh files</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="s1">&#39;./mesh/&#39;</span>
<span class="c1">-- Logging output from simulation</span>
<span class="n">logging</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">level</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
  <span class="c1">--filename = &#39;log&#39; -- filename to write logging output</span>
<span class="p">}</span>
<span class="c1">-- Interpolation method for multilevel simulation (linear, quadratic)</span>
<span class="n">interpolation_method</span> <span class="o">=</span> <span class="s1">&#39;quadratic&#39;</span>
<span class="c1">-- Debug outputs to write additional information</span>
<span class="n">NOdebug</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">logging</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;dbg&#39;</span><span class="p">,</span>
    <span class="n">root_only</span> <span class="o">=</span> <span class="kc">false</span> <span class="c1">-- all involved MPI processes writes output</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-simulation-control">4. Simulation Control</h3>
<p>We define the <code>sim_control</code> table <a href="https://apes-suite.github.io/treelm/module/tem_simcontrol_module.html">tem_simControl_module</a> containing
information about <code>time_control</code> <a href="https://apes-suite.github.io/treelm/module/tem_timecontrol_module.html">tem_timeControl_module</a> and
<code>abort_criteria</code> <a href="https://apes-suite.github.io/treelm/module/tem_abortcriteria_module.html">tem_abortCriteria_module</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Simulation Control]</span>
<span class="n">sim_control</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">time_control</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">max</span> <span class="o">=</span> <span class="p">{</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">tmax_phy</span> <span class="p">},</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="p">{</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">interval_phy</span> <span class="p">},</span>
    <span class="n">clock</span> <span class="o">=</span> <span class="mi">3600</span> <span class="c1">--s</span>
   <span class="p">},</span>
  <span class="c1">-- Abort conditions for simulation</span>
  <span class="n">abort_criteria</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">-- Abort if file with the name &#39;stop&#39; exist</span>
    <span class="n">stop_file</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
    <span class="c1">-- Abort if steady state is reached with condition defined in convergence</span>
    <span class="c1">-- table</span>
    <span class="n">steady_state</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="c1">-- Convergence condition for steady state check</span>
    <span class="n">convergence</span> <span class="o">=</span> <span class="p">{</span>
      <span class="c1">-- Variables to check</span>
      <span class="n">variable</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pressure_phy&#39;</span><span class="p">},</span>
      <span class="c1">-- Check only point in middle of domain</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
        <span class="n">object</span> <span class="o">=</span> <span class="p">{{</span><span class="n">origin</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">}</span> <span class="p">}}</span>
      <span class="p">},</span>
      <span class="c1">-- Reduce variables values in space to single average value</span>
      <span class="n">reduction</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;average&#39;</span><span class="p">},</span>
      <span class="c1">-- How often to do convergence?</span>
      <span class="n">time_control</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">min</span> <span class="o">=</span> <span class="n">tmax_phy</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>  <span class="c1">-- Start convergence check after half sim. time</span>
        <span class="n">max</span> <span class="o">=</span> <span class="n">tmax_phy</span><span class="p">,</span>      <span class="c1">-- DO convergence until end of simulation</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">dt</span>     <span class="c1">-- Do convernce check every 10*dt [s]</span>
      <span class="p">},</span>
      <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span>
      <span class="n">nvals</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
      <span class="n">absolute</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="c1">-- Condition to statisfy to every variable</span>
      <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.e-5</span><span class="p">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="p">},</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">--! [Simulation control]</span>
</code></pre></div>

<h3 id="5-fluid-identity-and-physics-table">5. Fluid, Identity and Physics Table</h3>
<p>We define the physics, identity and fluid table here.
These have been explained in <a href="tut_01_mus_config.html">[chapter 01]</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Physics parameters]</span>
<span class="c1">-- Required to convert physical unit to lattice unit</span>
<span class="n">physics</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">,</span>
  <span class="n">rho0</span> <span class="o">=</span> <span class="n">rho0_phy</span>
<span class="p">}</span>
<span class="c1">--! [Physics parameters]</span>


<span class="c1">--! [Scheme identifier]</span>
<span class="n">identify</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">layout</span> <span class="o">=</span> <span class="n">stencil</span><span class="p">,</span>
  <span class="n">relaxation</span> <span class="o">=</span> <span class="n">relaxationModel</span><span class="p">,</span>
  <span class="n">kind</span> <span class="o">=</span> <span class="n">physicsModel</span>
<span class="p">}</span>
<span class="c1">--! [Scheme identifier]</span>


<span class="c1">--! [Fluid]</span>
<span class="c1">-- For both, incompressible and compressible kinematic viscosity has to be</span>
<span class="c1">-- defined. While for the first one, default values are stored for bulk</span>
<span class="c1">-- viscosity,, the user has to explicitly give them for compr. fluid.</span>
<span class="kr">if</span> <span class="p">(</span><span class="n">physicsModel</span> <span class="o">==</span> <span class="s1">&#39;fluid&#39;</span><span class="p">)</span> <span class="kr">then</span>
  <span class="n">fluid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">kinematic_viscosity</span> <span class="o">=</span> <span class="n">nu_phy</span><span class="p">,</span>
    <span class="n">bulk_viscosity</span> <span class="o">=</span> <span class="n">bulk_visc</span>
  <span class="p">}</span>
<span class="kr">else</span>
  <span class="n">fluid</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kinematic_viscosity</span> <span class="o">=</span> <span class="n">nu_phy</span><span class="p">,</span>
    <span class="p">}</span>
<span class="kr">end</span>
<span class="c1">--! [Fluid]</span>
</code></pre></div>

<h3 id="6-initial-condition">6. Initial Condition</h3>
<p>Here we define the initial conditions for the simulation.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Initial conditions]</span>
<span class="n">initial_condition</span> <span class="o">=</span> <span class="p">{</span> <span class="n">pressure</span>  <span class="o">=</span> <span class="n">ic_pressure</span><span class="p">,</span>
                      <span class="n">velocityX</span> <span class="o">=</span> <span class="n">ic_velX</span><span class="p">,</span>
                      <span class="n">velocityY</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                      <span class="n">velocityZ</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                      <span class="n">Sxx</span> <span class="o">=</span> <span class="n">ic_Sxx</span><span class="p">,</span>
                      <span class="n">Syy</span> <span class="o">=</span> <span class="n">ic_Syy</span><span class="p">,</span>
                      <span class="n">Sxy</span> <span class="o">=</span> <span class="n">ic_Sxy</span>
                      <span class="p">}</span>
<span class="c1">--! [Initial conditions]</span>
</code></pre></div>

<h3 id="7-boundary-conditions">7. Boundary Conditions</h3>
<p>Next, we define the boundary conditions to handle the boundaries we have set up
in <code>seeder.lua</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- Label is a boundary identifier and it should be same as in seeder</span>
<span class="c1">-- configuration.</span>
<span class="n">boundary_condition</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span>
     <span class="n">kind</span>  <span class="o">=</span> <span class="s1">&#39;wall&#39;</span>
  <span class="p">},</span>
  <span class="p">{</span>  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span>
     <span class="n">kind</span>  <span class="o">=</span> <span class="s1">&#39;wall&#39;</span>
  <span class="p">},</span>
  <span class="p">{</span>  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;west&#39;</span><span class="p">,</span>
     <span class="n">kind</span>  <span class="o">=</span> <span class="s1">&#39;pressure_expol&#39;</span><span class="p">,</span>
     <span class="n">pressure</span> <span class="o">=</span> <span class="s1">&#39;pressureIn&#39;</span>
  <span class="p">},</span>
  <span class="p">{</span>  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;east&#39;</span><span class="p">,</span>
     <span class="n">kind</span>  <span class="o">=</span> <span class="s1">&#39;pressure_expol&#39;</span><span class="p">,</span>
     <span class="n">pressure</span> <span class="o">=</span> <span class="s1">&#39;pressureOut&#39;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">-- If we deactivated usePeriodic in seeder.lua, we have to add boundaries for</span>
<span class="c1">-- top and bottom.</span>
<span class="kr">if</span> <span class="n">usePeriodic</span> <span class="o">==</span> <span class="kc">false</span> <span class="kr">then</span>
  <span class="nb">table.insert</span><span class="p">(</span> <span class="n">boundary_condition</span><span class="p">,</span>
  <span class="p">{</span>  <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span>
     <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;wall&#39;</span>
  <span class="p">}</span>
  <span class="p">)</span>
  <span class="nb">table.insert</span><span class="p">(</span> <span class="n">boundary_condition</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;wall&#39;</span>
  <span class="p">}</span>
  <span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- If we activated useObstacle in seeder.lua, we have to add a boundary for it,</span>
<span class="c1">-- too. Label depends on 2D (cylinder) or 3D (sphere).</span>
<span class="kr">if</span> <span class="n">useObstacle</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
  <span class="nb">table.insert</span><span class="p">(</span> <span class="n">boundary_condition</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">stlLabel</span><span class="p">,</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;wall_libb&#39;</span>
  <span class="p">}</span>
  <span class="p">)</span>
 <span class="kr">end</span>
<span class="c1">--! [Boundary conditions]</span>
</code></pre></div>

<h3 id="8-variable-and-tracking-table">8. Variable and Tracking Table</h3>
<p>During the simulation we track variables to have a look at e.g. the pressure
over time. Therefore we use the <a href="https://apes-suite.github.io/treelm/module/tem_tracking_module.html">tem_tracking_module</a>. If we want to
make use of different than the default values we define the <code>variable</code> table
that is explained <a href="https://apes-suite.github.io/treelm//page/features/variables/index.html">here</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [User defined variables]</span>
<span class="c1">-- Mainly used for tracking.</span>
<span class="c1">-- This variable can be refered to as variable in boundary condition and source</span>
<span class="n">variable</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">-- Reference pressure dependent on physicsModel</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pressureRef&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;st_fun&#39;</span><span class="p">,</span>
    <span class="n">st_fun</span> <span class="o">=</span> <span class="n">pressureRef</span>
  <span class="p">},</span>
  <span class="c1">-- Background pressure</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pressure0&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;st_fun&#39;</span><span class="p">,</span>
    <span class="n">st_fun</span> <span class="o">=</span> <span class="n">press_ambient</span>
  <span class="p">},</span>
  <span class="c1">-- Pressure at inlet</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pressureIn&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;st_fun&#39;</span><span class="p">,</span>
    <span class="n">st_fun</span> <span class="o">=</span> <span class="n">pressureIn</span>
  <span class="p">},</span>
  <span class="c1">-- Pressure at outlet</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pressureOut&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;st_fun&#39;</span><span class="p">,</span>
    <span class="n">st_fun</span> <span class="o">=</span> <span class="n">pressureOut</span>
  <span class="p">},</span>
  <span class="c1">-- Reference shear stress</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stressRef&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;st_fun&#39;</span><span class="p">,</span>
    <span class="n">st_fun</span> <span class="o">=</span> <span class="n">stressRef</span> <span class="p">},</span>
  <span class="c1">-- Difference between numerical pressure and reference pressure</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;press_error&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;operation&#39;</span><span class="p">,</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span>
      <span class="n">input_varname</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;pressure_phy&#39;</span><span class="p">,</span> <span class="s1">&#39;pressureRef&#39;</span><span class="p">,},</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="c1">-- Difference between numerical pressure and background pressure</span>
  <span class="p">{</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;press_fluc&#39;</span><span class="p">,</span>
    <span class="n">ncomponents</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;operation&#39;</span><span class="p">,</span>
    <span class="n">operation</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span>
      <span class="n">input_varname</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;pressure_phy&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure0&#39;</span><span class="p">,},</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">}</span>
<span class="c1">--! [User defined variables]</span>
</code></pre></div>

<p>Now we need to define the tracking. We only use one example here. Inside the
example <code>musubi.lua</code> a lot more trackings can be found. The next
<a href="tut_03_tracking.html">[chapter 03]</a> will explain the tracking in more detail.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Tracking example]</span>
<span class="n">tracking</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">-- Track pressure at the center of the channel over time.</span>
  <span class="p">{</span>
    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;probeAtCenter&#39;</span><span class="p">,</span>
    <span class="c1">--label = &#39;probePressure&#39;,</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="s1">&#39;tracking/&#39;</span><span class="p">,</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pressure_phy&#39;</span><span class="p">},</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;canoND&#39;</span><span class="p">,</span>
      <span class="n">object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="n">time_control</span> <span class="o">=</span> <span class="p">{</span> <span class="n">min</span> <span class="o">=</span> <span class="p">{</span><span class="n">iter</span><span class="o">=</span><span class="mi">1</span><span class="p">},</span> <span class="n">interval</span> <span class="o">=</span> <span class="p">{</span><span class="n">iter</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span> <span class="p">},</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span> <span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;ascii&#39;</span> <span class="p">},</span>
  <span class="p">},</span>
<span class="c1">--! [Tracking example]</span>
</code></pre></div>

<h3 id="9-restart-table">9. Restart Table</h3>
<p>We need to define a table for a restart of our simultion. If this table doesn't
exist, no restart files will be created. Find more information in
<a href="tut_05_restart.html">[chapter 05]</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">--! [Restart]</span>
<span class="c1">-- Without timeControl restart will be dumped by default at end</span>
<span class="c1">-- of simulation when write restart is set.</span>
<span class="n">restart</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">NOread</span> <span class="o">=</span> <span class="s1">&#39;restart/channel2D_lastHeader.lua&#39;</span><span class="p">,</span>
  <span class="n">write</span> <span class="o">=</span> <span class="s1">&#39;restart/&#39;</span><span class="p">,</span>
  <span class="n">time_control</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">min</span> <span class="o">=</span> <span class="p">{</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">rest_start</span> <span class="p">},</span>
    <span class="n">max</span> <span class="o">=</span> <span class="p">{</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">tmax_phy</span> <span class="p">},</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="p">{</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">interval_phy</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">--! [Restart]</span>
</code></pre></div>

<p>Now run the simulation with:
<code>~/apes/musubi/build/musubi musubi.lua</code></p>
<h2 id="post-process-the-results">Post-Process the Results</h2>
<p>After the simulation run you can have a look at the vtk files with Paraview.
Here, you can see a possible output from Paraview:</p>
<p><img alt="pressure_paraview2D" src="images/cylinder_pressure_screenshot_2D.png" title="2D channel with tracked pressure"></p>
<p>Now you are free to go on with the next chapter that deals with Tracking.</p>
<p>Next chapter: <a href="tut_03_tracking.html">Tracking &rarr;</a></p>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              Musubi
 was developed by University of Siegen<br>              &copy; 2025 
<br /><small>1f26b0f34ef8</small></p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
 on 2025-05-12T17:10:20.421441+0000             </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>
  </body>
</html>